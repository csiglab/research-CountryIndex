<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Actor Timeline Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: '#0a0e14',
            surface: '#131920',
            border: '#252d38',
            muted: '#6b7a8f',
            fg: '#e1e8f0',
            accent: '#4fa3d1',
            // Model colors
            private: '#4fa3d1', // Blue
            hybrid: '#f5c542',  // Yellow
            public: '#e85d5d',  // Red
            card: '#1a2129',
          },
          fontFamily: {
            mono: ['JetBrains Mono', 'monospace'],
            sans: ['Space Grotesk', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Space Grotesk', sans-serif; background: #0a0e14; }
    
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #131920; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #252d38; border-radius: 3px; }
    
    .tooltip-enter { animation: tooltipIn 0.1s ease-out forwards; }
    @keyframes tooltipIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    
    .panel-slide { animation: panelSlide 0.2s ease-out forwards; }
    @keyframes panelSlide { from { transform: translateX(100%); } to { transform: translateX(0); } }
    
    @media (prefers-reduced-motion: reduce) { .tooltip-enter, .panel-slide { animation: none; } }
    
    .btn-tool { transition: all 0.1s ease; }
    .btn-tool:hover:not(:disabled) { background: #252d38; }
    .btn-tool:active:not(:disabled) { transform: scale(0.95); }
    
    .filter-btn {
      transition: all 0.15s ease;
      cursor: pointer;
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    .filter-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: currentColor;
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    .filter-btn:hover::before { opacity: 0.1; }
    .filter-btn.active { 
      background: var(--btn-color, #4fa3d1);
      color: #0a0e14;
      border-color: transparent;
      font-weight: 600;
    }
    .filter-btn.active::before { opacity: 0; }
    
    .filter-btn[data-type="all"].active { --btn-color: #e1e8f0; }
    .filter-btn[data-type="private"].active { --btn-color: #4fa3d1; }
    .filter-btn[data-type="hybrid"].active { --btn-color: #f5c542; }
    .filter-btn[data-type="public"].active { --btn-color: #e85d5d; }
    
    input:focus, button:focus-visible { outline: 1px solid #4fa3d1; outline-offset: -1px; }
    
    .header-gradient {
      background: linear-gradient(135deg, #1a1f35 0%, #0f1724 50%, #0a1628 100%);
      position: relative;
    }
    .header-gradient::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(79, 163, 209, 0.08) 0%, transparent 40%, transparent 60%, rgba(79, 163, 209, 0.05) 100%);
      pointer-events: none;
    }
    
    .search-input {
      background: rgba(10, 14, 20, 0.6);
      border: 1px solid rgba(107, 122, 143, 0.3);
      transition: all 0.2s ease;
    }
    .search-input:focus {
      background: rgba(10, 14, 20, 0.9);
      border-color: rgba(79, 163, 209, 0.5);
      box-shadow: 0 0 0 3px rgba(79, 163, 209, 0.1);
    }
  </style>
</head>
<body class="text-fg min-h-screen flex items-center justify-center p-4 md:p-8">

  <div id="app" class="w-full max-w-6xl mx-auto" style="margin: 5vh 10%;">
    
    <!-- Main Grid Container -->
    <div class="bg-surface border border-border rounded-xl shadow-2xl shadow-black/60 overflow-hidden">
      
      <div class="grid grid-cols-[70px_1fr_50px]">
        
        <!-- Header Bar -->
        <div class="col-span-3 header-gradient border-b border-border relative">
          <div class="flex items-center justify-center px-5 py-3.5 gap-4 flex-wrap">
            
            <!-- Search + Filters Group -->
            <div class="flex items-center gap-3">
              
              <!-- Search Box -->
              <div class="relative w-48 md:w-64 flex-shrink-0">
                <input 
                  type="text" 
                  id="searchInput" 
                  placeholder="Search actors by name..."
                  class="search-input w-full rounded-lg px-3 py-2 pl-9 text-sm font-mono placeholder:text-muted/50"
                  aria-label="Search actors"
                >
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
              </div>
              
              <!-- Filter Buttons -->
              <div class="flex items-center gap-1.5" role="group" aria-label="Filter by sector">
                <button id="tagAll" data-type="all" class="filter-btn active px-3 py-1.5 rounded-md text-xs font-medium text-fg/70 border border-border/50">
                  All
                </button>
                <button id="tagPrivate" data-type="private" class="filter-btn px-3 py-1.5 rounded-md text-xs font-medium text-private border border-private/30">
                  Private
                </button>
                <button id="tagHybrid" data-type="hybrid" class="filter-btn px-3 py-1.5 rounded-md text-xs font-medium text-hybrid border border-hybrid/30">
                  Hybrid
                </button>
                <button id="tagPublic" data-type="public" class="filter-btn px-3 py-1.5 rounded-md text-xs font-medium text-public border border-public/30">
                  Public
                </button>
              </div>
              
            </div>
            
          </div>
        </div>
        
        <!-- Middle Left: Time Axis -->
        <div class="border-r border-border bg-bg/10 relative">
          <canvas id="axisCanvas" class="absolute inset-0 w-full h-full"></canvas>
        </div>
        
        <!-- Middle Center: Main Timeline -->
        <div id="timelineContainer" class="relative bg-surface" style="height: 520px;">
          <canvas id="timelineCanvas" class="absolute inset-0 w-full h-full"></canvas>
          
          <!-- Legend Labels (Inside Visualization, Top Right) -->
          <div class="absolute top-4 right-4 bg-card/90 backdrop-blur-sm border border-border rounded-lg p-3 z-10 flex flex-col gap-2 text-xs text-muted shadow-lg">
            <div class="flex items-center gap-2">
              <svg class="w-3.5 h-3.5 text-private" viewBox="0 0 10 10"><circle cx="5" cy="5" r="4" fill="currentColor"/></svg>
              <span>Private</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-3.5 h-3.5 text-hybrid" viewBox="0 0 10 10"><rect x="1" y="1" width="8" height="8" fill="currentColor"/></svg>
              <span>Hybrid</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-3.5 h-3.5 text-public" viewBox="0 0 10 10"><polygon points="5,1 9,9 1,9" fill="currentColor"/></svg>
              <span>Public</span>
            </div>
          </div>
          
          <!-- Tooltip -->
          <div id="tooltip" class="absolute pointer-events-none opacity-0 z-20 bg-card border border-border rounded-md shadow-xl p-2.5 max-w-xs backdrop-blur-sm"></div>
        </div>
        
        <!-- Middle Right: Vertical Control Bar -->
        <div class="border-l border-border bg-bg/10 flex flex-col items-center">
          
          <!-- Zoom Controls -->
          <div class="py-2 border-b border-border flex flex-col gap-1">
            <button id="btnZoomIn" class="btn-tool w-7 h-7 flex items-center justify-center rounded bg-card text-muted text-sm font-bold" title="Zoom In (+)">+</button>
            <button id="btnZoomOut" class="btn-tool w-7 h-7 flex items-center justify-center rounded bg-card text-muted text-sm font-bold" title="Zoom Out (-)">−</button>
          </div>
          
          <!-- View Controls -->
          <div class="py-2 border-b border-border flex flex-col gap-1">
            <button id="btnReset" class="btn-tool w-7 h-7 flex items-center justify-center rounded bg-card text-muted" title="Reset (R)">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            </button>
            <button id="btnFitAll" class="btn-tool w-7 h-7 flex items-center justify-center rounded bg-card text-muted" title="Fit All (F)">
               <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
            </button>
          </div>
          
          <!-- Help -->
          <div class="py-2 border-b border-border">
            <button id="btnHelp" class="btn-tool w-7 h-7 flex items-center justify-center rounded bg-card text-muted text-xs" title="Help (?)">?</button>
          </div>
          
          <!-- Minimap -->
          <div id="minimapContainer" class="flex-1 relative cursor-pointer bg-bg/20 w-full">
            <canvas id="minimapCanvas" class="absolute inset-0 w-full h-full"></canvas>
            <div id="minimapViewport" class="absolute border border-accent/60 bg-accent/5 rounded-sm cursor-move" style="left: 4px; width: calc(100% - 8px);"></div>
          </div>
        </div>
        
      </div>
      
      <!-- Minimal Footer Line -->
      <div class="h-px bg-border/50"></div>
    </div>
  </div>
  
  <!-- Detail Panel -->
  <div id="detailPanel" class="fixed inset-y-0 right-0 w-full md:w-80 bg-surface/95 backdrop-blur-md border-l border-border shadow-2xl z-50 hidden overflow-hidden flex-col">
    <div class="p-4 border-b border-border flex items-center justify-between">
      <h2 class="text-base font-semibold">Details</h2>
      <button id="closePanel" class="w-7 h-7 flex items-center justify-center rounded hover:bg-card text-muted hover:text-fg" aria-label="Close">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div id="panelContent" class="flex-1 overflow-y-auto p-4 scrollbar-thin"></div>
  </div>
  
  <!-- Help Modal -->
  <div id="helpModal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
    <div class="bg-surface border border-border rounded-xl max-w-sm w-full shadow-2xl">
      <div class="p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Shortcuts</h2>
          <button id="closeHelp" class="w-7 h-7 flex items-center justify-center rounded hover:bg-card text-muted hover:text-fg" aria-label="Close help">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="space-y-1 text-xs">
          <div class="flex justify-between py-1.5 border-b border-border"><span class="text-muted">Navigate</span><div><kbd class="px-1.5 py-0.5 bg-card rounded border border-border font-mono">j</kbd> <kbd class="px-1.5 py-0.5 bg-card rounded border border-border font-mono">k</kbd></div></div>
          <div class="flex justify-between py-1.5 border-b border-border"><span class="text-muted">Zoom</span><div><kbd class="px-1.5 py-0.5 bg-card rounded border border-border font-mono">+</kbd> <kbd class="px-1.5 py-0.5 bg-card rounded border border-border font-mono">-</kbd></div></div>
          <div class="flex justify-between py-1.5 border-b border-border"><span class="text-muted">Reset</span><kbd class="px-1.5 py-0.5 bg-card rounded border border-border font-mono">r</kbd></div>
          <div class="flex justify-between py-1.5 border-b border-border"><span class="text-muted">Toggle Lane</span><div><kbd class="px-1.5 py-0.5 bg-card rounded border border-border font-mono">1</kbd> <kbd class="px-1.5 py-0.5 bg-card rounded border border-border font-mono">2</kbd> <kbd class="px-1.5 py-0.5 bg-card rounded border border-border font-mono">3</kbd></div></div>
          <div class="flex justify-between py-1.5"><span class="text-muted">Select</span><kbd class="px-1.5 py-0.5 bg-card rounded border border-border font-mono">Enter</kbd></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // DATA & CONFIG
    // ========================================
    const ACTORS = {
      private: ['Mitsubishi', 'Siemens', 'Tata Group', 'Koch Ind', 'Cargill', 'Bechtel', 'Bosch', 'Trafigura', 'Vitol', 'Hilti'],
      hybrid: ['Red Cross', 'WWF', 'Amnesty', 'Doctors Without Borders', 'Oxfam', 'Save Children', 'United Way', 'Smithsonian'],
      public: ['UN', 'WHO', 'UNESCO', 'IMF', 'World Bank', 'EU', 'African Union', 'NATO', 'Interpol', 'WTO']
    };
    const EVENTS = { private: ['founded', 'acquired', 'merged'], hybrid: ['established', 'reformed', 'campaign'], public: ['treaty', 'resolution', 'summit'] };
    const REGIONS = ['North America', 'Europe', 'Asia-Pacific', 'Global'];

    function genData(count = 250) {
      const d = []; let id = 1;
      for (let i = 0; i < count; i++) {
        const t = ['private', 'hybrid', 'public'][Math.floor(Math.random() * 3)];
        let y; const r = Math.random();
        if (r < 0.2) y = 1800 + Math.floor(Math.random() * 70);
        else if (r < 0.5) y = 1870 + Math.floor(Math.random() * 60);
        else if (r < 0.8) y = 1930 + Math.floor(Math.random() * 50);
        else y = 1980 + Math.floor(Math.random() * 45);
        
        d.push({
          id: id++, actor: ACTORS[t][Math.floor(Math.random() * ACTORS[t].length)], type: t,
          eventType: EVENTS[t][Math.floor(Math.random() * EVENTS[t].length)],
          year: y, month: Math.floor(Math.random() * 12), day: Math.floor(Math.random() * 28) + 1,
          region: REGIONS[Math.floor(Math.random() * REGIONS.length)], importance: Math.random() * 0.5 + 0.5
        });
      }
      return d.sort((a,b) => a.year - b.year);
    }

    // ========================================
    // ENGINE
    // ========================================
    class Timeline {
      constructor() {
        this.data = genData(300);
        this.filtered = [...this.data];
        this.state = { zoom: 1, panY: 0, filters: { private: true, hybrid: true, public: true }, activeFilter: 'all', search: '' };
        
        this.canvas = document.getElementById('timelineCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.axisCanvas = document.getElementById('axisCanvas');
        this.axisCtx = this.axisCanvas.getContext('2d');
        this.minimapCanvas = document.getElementById('minimapCanvas');
        this.minimapCtx = this.minimapCanvas.getContext('2d');
        
        this.container = document.getElementById('timelineContainer');
        this.mmContainer = document.getElementById('minimapContainer');
        
        this.layout = {
          w: 0, h: 0, dpr: 1,
          ml: 10, mt: 20, mb: 10,
          laneW: 0,
          cols: { private: 0, hybrid: 0, public: 0 }
        };
        
        // Model Colors: Blue Private, Yellow Hybrid, Red Public
        this.lanes = {
          private: { color: '#4fa3d1', shape: 'circle' },
          hybrid: { color: '#f5c542', shape: 'square' },
          public: { color: '#e85d5d', shape: 'triangle' }
        };

        this.hovered = null;
        this.packed = new Map();
        
        this.init();
      }

      init() {
        this.resize();
        this.bindEvents();
        this.applyState();
        this.render();
      }

      resize() {
        this.layout.dpr = window.devicePixelRatio || 1;
        
        const rect = this.container.getBoundingClientRect();
        this.canvas.width = rect.width * this.layout.dpr;
        this.canvas.height = rect.height * this.layout.dpr;
        this.ctx.scale(this.layout.dpr, this.layout.dpr);
        this.layout.w = rect.width;
        this.layout.h = rect.height;
        
        const axisRect = this.axisCanvas.parentElement.getBoundingClientRect();
        this.axisCanvas.width = axisRect.width * this.layout.dpr;
        this.axisCanvas.height = axisRect.height * this.layout.dpr;
        this.axisCtx.scale(this.layout.dpr, this.layout.dpr);
        
        const mmRect = this.mmContainer.getBoundingClientRect();
        this.minimapCanvas.width = mmRect.width * this.layout.dpr;
        this.minimapCanvas.height = mmRect.height * this.layout.dpr;
        this.minimapCtx.scale(this.layout.dpr, this.layout.dpr);
        
        const chartW = this.layout.w - this.layout.ml - this.layout.mr;
        this.layout.laneW = chartW / 3;
        this.layout.cols.private = this.layout.ml;
        this.layout.cols.hybrid = this.layout.ml + this.layout.laneW;
        this.layout.cols.public = this.layout.ml + this.layout.laneW * 2;
        
        this.pack();
        this.render();
      }

      bindEvents() {
        window.addEventListener('resize', () => this.resize());
        this.canvas.addEventListener('mousemove', e => this.onHover(e));
        this.canvas.addEventListener('mouseleave', () => this.onLeave());
        this.canvas.addEventListener('click', e => this.onClick(e));
        this.canvas.addEventListener('wheel', e => this.onWheel(e), { passive: false });
        
        document.getElementById('searchInput').addEventListener('input', e => {
          this.state.search = e.target.value.toLowerCase();
          this.applyState();
        });
        
        // All button
        document.getElementById('tagAll').addEventListener('click', () => {
          const allActive = this.state.filters.private && this.state.filters.hybrid && this.state.filters.public;
          if (allActive) {
            this.state.filters = { private: true, hybrid: true, public: true };
            this.state.activeFilter = 'all';
          } else {
            this.state.filters = { private: true, hybrid: true, public: true };
            this.state.activeFilter = 'all';
          }
          this.applyState();
        });
        
        // Individual filter buttons
        ['private', 'hybrid', 'public'].forEach(k => {
          document.getElementById(`tag${k.charAt(0).toUpperCase() + k.slice(1)}`).addEventListener('click', () => {
            this.state.filters[k] = !this.state.filters[k];
            
            // Update activeFilter state
            const activeCount = Object.values(this.state.filters).filter(Boolean).length;
            if (activeCount === 3) {
              this.state.activeFilter = 'all';
            } else if (activeCount === 0) {
              // Prevent all filters being off - re-enable the clicked one
              this.state.filters[k] = true;
              this.state.activeFilter = k;
            } else {
              this.state.activeFilter = 'mixed';
            }
            this.applyState();
          });
        });
        
        document.getElementById('btnZoomIn').addEventListener('click', () => this.zoom(1.4));
        document.getElementById('btnZoomOut').addEventListener('click', () => this.zoom(0.7));
        document.getElementById('btnReset').addEventListener('click', () => this.reset());
        document.getElementById('btnFitAll').addEventListener('click', () => this.fit());
        document.getElementById('btnHelp').addEventListener('click', () => this.toggleHelp(true));
        document.getElementById('closeHelp').addEventListener('click', () => this.toggleHelp(false));
        document.getElementById('closePanel').addEventListener('click', () => this.togglePanel(false));
        document.getElementById('helpModal').addEventListener('click', e => { if(e.target.id === 'helpModal') this.toggleHelp(false); });
        
        let isDrag = false, startY = 0;
        this.mmContainer.addEventListener('mousedown', e => {
            isDrag = true; startY = e.clientY;
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        });
        const onDrag = e => {
            if(!isDrag) return;
            const dy = e.clientY - startY;
            const sens = 20;
            this.state.panY += dy * sens / (this.state.zoom * this.layout.h);
            startY = e.clientY;
            this.render();
        };
        const stopDrag = () => { isDrag = false; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', stopDrag); };

        document.addEventListener('keydown', e => this.onKey(e));
      }

      applyState() {
        this.filtered = this.data.filter(d => 
          this.state.filters[d.type] && 
          (!this.state.search || d.actor.toLowerCase().includes(this.state.search) || d.eventType.toLowerCase().includes(this.state.search))
        );
        
        // Update button states
        const allBtn = document.getElementById('tagAll');
        const allActive = this.state.filters.private && this.state.filters.hybrid && this.state.filters.public;
        
        allBtn.classList.toggle('active', allActive);
        
        ['private', 'hybrid', 'public'].forEach(k => {
          const btn = document.getElementById(`tag${k.charAt(0).toUpperCase() + k.slice(1)}`);
          btn.classList.toggle('active', this.state.filters[k]);
        });
        
        this.pack();
        this.render();
      }

      pack() {
        this.packed.clear();
        const groups = { private: {}, hybrid: {}, public: {} };
        this.filtered.forEach(d => {
            if(!groups[d.type][d.year]) groups[d.type][d.year] = [];
            groups[d.type][d.year].push(d);
        });
        
        Object.keys(groups).forEach(type => {
            const laneX = this.layout.cols[type] + this.layout.laneW / 2;
            Object.keys(groups[type]).forEach(year => {
                const evts = groups[type][year];
                const w = this.layout.laneW - 20;
                const step = Math.min(30, w / evts.length);
                const startX = laneX - (evts.length - 1) * step / 2;
                
                evts.forEach((e, i) => {
                    this.packed.set(e.id, { x: startX + i * step });
                });
            });
        });
      }
      
      yearToY(y) {
        const range = (2025 - 1800) / this.state.zoom;
        const center = (1800 + 2025) / 2 - this.state.panY * range;
        const ratio = (y - (center - range/2)) / range;
        return this.layout.mt + ratio * (this.layout.h - this.layout.mt - this.layout.mb);
      }

      zoom(factor) {
        this.state.zoom = Math.max(1, Math.min(20, this.state.zoom * factor));
        this.render();
      }
      
      reset() {
        this.state.zoom = 1; this.state.panY = 0;
        this.render();
      }
      
      fit() {
        if(this.filtered.length === 0) return;
        const years = this.filtered.map(d => d.year);
        const range = Math.max(...years) - Math.min(...years) + 20;
        this.state.zoom = 225 / range;
        this.render();
      }

      onHover(e) {
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left, y = e.clientY - rect.top;
        let found = null;
        
        for(const d of this.filtered) {
            const py = this.yearToY(d.year);
            const pos = this.packed.get(d.id);
            if(!pos) continue;
            const dist = Math.sqrt((x-pos.x)**2 + (y-py)**2);
            if(dist < 12) { found = d; break; }
        }
        
        if(found !== this.hovered) {
            this.hovered = found;
            this.canvas.style.cursor = found ? 'pointer' : 'default';
            if(found) this.showTooltip(found, e.clientX, e.clientY);
            else this.hideTooltip();
            this.render();
        }
      }
      
      onLeave() {
        this.hovered = null; this.hideTooltip(); this.render();
      }
      
      onClick() {
        if(this.hovered) this.togglePanel(true, this.hovered);
      }
      
      onWheel(e) {
        e.preventDefault();
        const d = e.deltaY > 0 ? 0.9 : 1.1;
        this.zoom(d);
      }
      
      onKey(e) {
        if(e.target.tagName === 'INPUT') return;
        switch(e.key) {
          case '+': case '=': this.zoom(1.2); break;
          case '-': this.zoom(0.8); break;
          case 'r': this.reset(); break;
          case 'f': this.fit(); break;
          case '1': this.state.filters.private = !this.state.filters.private; this.applyState(); break;
          case '2': this.state.filters.hybrid = !this.state.filters.hybrid; this.applyState(); break;
          case '3': this.state.filters.public = !this.state.filters.public; this.applyState(); break;
          case '?': this.toggleHelp(true); break;
          case 'Escape': this.togglePanel(false); this.toggleHelp(false); break;
        }
      }

      toggleHelp(show) {
        document.getElementById('helpModal').classList.toggle('hidden', !show);
        document.getElementById('helpModal').classList.toggle('flex', show);
      }
      
      togglePanel(show, data = null) {
        const panel = document.getElementById('detailPanel');
        panel.classList.toggle('hidden', !show);
        if(show && data) {
            panel.classList.add('panel-slide');
            const lane = this.lanes[data.type];
            document.getElementById('panelContent').innerHTML = `
              <div class="space-y-3 text-sm">
                <div class="flex items-center gap-2">
                   <span style="color:${lane.color}">${lane.shape==='circle'?'●':lane.shape==='square'?'■':'▲'}</span>
                   <span class="font-semibold">${data.actor}</span>
                </div>
                <div class="text-xs text-muted font-mono">${data.type.toUpperCase()} • ${data.year}</div>
                <p class="text-xs">${data.eventType} in ${data.region}</p>
              </div>
            `;
        }
      }

      showTooltip(d, mx, my) {
        const lane = this.lanes[d.type];
        const el = document.getElementById('tooltip');
        el.innerHTML = `<div class="text-xs font-mono"><span style="color:${lane.color}">${lane.shape==='circle'?'●':lane.shape==='square'?'■':'▲'}</span> ${d.actor} <span class="text-muted">${d.year}</span></div>`;
        
        const rect = this.container.getBoundingClientRect();
        let left = mx - rect.left + 10, top = my - rect.top + 10;
        if(left + 150 > this.layout.w) left -= 160;
        
        el.style.left = left + 'px';
        el.style.top = top + 'px';
        el.classList.remove('opacity-0');
        el.classList.add('tooltip-enter');
      }
      
      hideTooltip() {
        document.getElementById('tooltip').classList.add('opacity-0');
      }

      render() {
        this.renderAxis();
        this.renderMain();
        this.renderMinimap();
      }
      
      renderAxis() {
        const ctx = this.axisCtx;
        const rect = this.axisCanvas.parentElement.getBoundingClientRect();
        const h = rect.height;
        
        ctx.clearRect(0, 0, rect.width, h);
        ctx.fillStyle = '#0a0e14'; ctx.fillRect(0,0,rect.width,h);
        
        ctx.font = '10px "JetBrains Mono"';
        ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
        ctx.fillStyle = '#6b7a8f';
        
        const range = (2025 - 1800) / this.state.zoom;
        const center = (1800 + 2025) / 2 - this.state.panY * range;
        const start = Math.ceil(center - range/2);
        
        let step = 25;
        if(range < 100) step = 10;
        if(range < 30) step = 5;
        if(range < 10) step = 1;
        
        for(let y = Math.floor(start/step)*step; y < start + range; y+=step) {
           const py = this.yearToY(y);
           if(py > 20 && py < h - 20) {
             ctx.fillText(y.toString(), rect.width - 10, py);
           }
        }
      }

      renderMain() {
        const ctx = this.ctx;
        const w = this.layout.w, h = this.layout.h;
        
        ctx.fillStyle = '#131920'; ctx.fillRect(0,0,w,h);
        
        ctx.strokeStyle = '#1a2129';
        ctx.beginPath();
        ctx.moveTo(this.layout.cols.hybrid, this.layout.mt); ctx.lineTo(this.layout.cols.hybrid, h);
        ctx.moveTo(this.layout.cols.public, this.layout.mt); ctx.lineTo(this.layout.cols.public, h);
        ctx.stroke();
        
        const range = (2025 - 1800) / this.state.zoom;
        const center = (1800 + 2025) / 2 - this.state.panY * range;
        const start = Math.ceil(center - range/2);
        ctx.strokeStyle = '#1a2129'; ctx.lineWidth = 0.5;
        for(let y = start; y < start + range; y+=10) {
           const py = this.yearToY(y);
           if(py > this.layout.mt && py < h - 10) {
             ctx.beginPath(); ctx.moveTo(this.layout.ml, py); ctx.lineTo(w-this.layout.mr, py); ctx.stroke();
           }
        }
        
        this.filtered.forEach(d => {
           const py = this.yearToY(d.year);
           if(py < -10 || py > h + 10) return;
           
           const pos = this.packed.get(d.id);
           if(!pos) return;
           
           const lane = this.lanes[d.type];
           const size = 4 + d.importance * 4;
           const isH = this.hovered && this.hovered.id === d.id;
           
           ctx.save();
           if(isH) {
             ctx.shadowColor = lane.color;
             ctx.shadowBlur = 10;
           }
           ctx.fillStyle = lane.color;
           if(isH) ctx.globalAlpha = 1; else ctx.globalAlpha = 0.7;
           
           ctx.beginPath();
           if(lane.shape === 'circle') ctx.arc(pos.x, py, size, 0, Math.PI*2);
           else if(lane.shape === 'square') ctx.rect(pos.x-size, py-size, size*2, size*2);
           else { ctx.moveTo(pos.x, py-size); ctx.lineTo(pos.x+size, py+size); ctx.lineTo(pos.x-size, py+size); ctx.closePath(); }
           ctx.fill();
           ctx.restore();
        });
      }

      renderMinimap() {
        const ctx = this.minimapCtx;
        const rect = this.mmContainer.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        
        ctx.fillStyle = '#0a0e14'; ctx.fillRect(0,0,w,h);
        
        this.filtered.forEach(d => {
           const py = ((d.year - 1800) / 225) * h;
           const lane = this.lanes[d.type];
           const x = w/2 + (d.type === 'private' ? -w/4 : d.type === 'public' ? w/4 : 0);
           ctx.fillStyle = lane.color; ctx.globalAlpha = 0.3;
           ctx.fillRect(x-1, py, 2, 2);
        });
        ctx.globalAlpha = 1;
        
        const range = (2025 - 1800) / this.state.zoom;
        const center = (1800 + 2025) / 2 - this.state.panY * range;
        const top = ((center - range/2 - 1800) / 225) * h;
        const vpH = (range / 225) * h;
        
        const vp = document.getElementById('minimapViewport');
        vp.style.top = Math.max(0, Math.min(h-10, top)) + 'px';
        vp.style.height = Math.max(10, Math.min(h, vpH)) + 'px';
      }
    }

    document.addEventListener('DOMContentLoaded', () => new Timeline());
  </script>
</body>
</html>