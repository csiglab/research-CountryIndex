<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INDEX GENTIUM — Laboratorium Arbitristae</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: '#FAFBFC',
            fg: '#1E293B',
            muted: '#64748B',
            accent: '#4A6FA5',
            accentDark: '#3A5A8A',
            card: '#FFFFFF',
            border: '#E2E8F0',
            navy: '#1B2838',
          },
          fontFamily: {
            display: ['"Cormorant Garamond"', 'Georgia', 'serif'],
            body: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['"JetBrains Mono"', 'monospace'],
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --bg: #FAFBFC;
      --fg: #1E293B;
      --muted: #64748B;
      --accent: #4A6FA5;
      --accent-dark: #3A5A8A;
      --card: #FFFFFF;
      --border: #E2E8F0;
      --navy: #1B2838;
      --footer-bg: #0B1A2B;
      --footer-text: #B8C5D4;
      --footer-text-light: #E8EDF3;
      --footer-muted: #5A7089;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: var(--bg);
      color: var(--fg);
      line-height: 1.6;
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }

    .main-content {
      flex: 1 0 auto;
    }

    .site-footer {
      flex-shrink: 0;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-entrance {
      opacity: 0;
      animation: fadeInUp 250ms ease-out forwards;
    }

    .delay-1 { animation-delay: 0ms; }
    .delay-2 { animation-delay: 80ms; }
    .delay-3 { animation-delay: 150ms; }
    .delay-4 { animation-delay: 250ms; }
    .delay-5 { animation-delay: 350ms; }

    @media (prefers-reduced-motion: reduce) {
      .animate-entrance {
        animation: none;
        opacity: 1;
      }
    }

    /* Search Module - Static flow layout to prevent overlap */
    .search-module {
      position: relative;
    }

    .search-input {
      transition: border-color 150ms ease-out, box-shadow 150ms ease-out;
    }

    .search-input:hover {
      border-color: #CBD5E1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.12);
    }

    /* Dropdown panel - Static block element (Normal Flow) */
    /* This ensures it pushes content down instead of overlapping */
    .search-dropdown {
      position: relative; /* Static flow */
      margin-top: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
      
      display: none; /* Hidden by default */
      opacity: 0;
      transform: translateY(-8px);
      transition: opacity 150ms ease-out, transform 150ms ease-out;
      
      overflow: hidden;
      max-height: 420px; /* Approx height for 5 items + metadata */
    }

    .search-dropdown.open {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    /* Metadata summary section */
    .dropdown-metadata {
      padding: 12px 16px;
      background: rgba(74, 111, 165, 0.03);
      border-bottom: 1px solid var(--border);
    }

    .dropdown-metadata-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .dropdown-metadata-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .metadata-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .metadata-stat-value {
      font-weight: 600;
      font-size: 14px;
      color: var(--fg);
    }

    .metadata-stat-label {
      font-size: 12px;
      color: var(--muted);
    }

    /* Results section */
    .dropdown-results {
      max-height: 300px; /* Limits visible area to ~5 items */
      overflow-y: auto;
      overscroll-behavior: contain; /* Prevents scroll chaining */
    }

    .dropdown-results-header {
      padding: 8px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      background: var(--card);
      position: sticky;
      top: 0;
      border-bottom: 1px solid var(--border);
      z-index: 1;
    }

    .search-dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 100ms ease-out;
      border-bottom: 1px solid var(--border);
    }

    .search-dropdown-item:last-child {
      border-bottom: none;
    }

    .search-dropdown-item:hover,
    .search-dropdown-item.active {
      background-color: rgba(74, 111, 165, 0.05);
    }

    .search-dropdown-item.active {
      background-color: rgba(74, 111, 165, 0.08);
    }

    .search-dropdown-item:focus {
      outline: none;
      background-color: rgba(74, 111, 165, 0.08);
    }

    /* Scroll hint */
    .scroll-indicator {
      padding: 10px 16px;
      text-align: center;
      font-size: 11px;
      color: var(--muted);
      background: rgba(74, 111, 165, 0.02);
      border-top: 1px solid var(--border);
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 0.02em;
    }

    /* Card hover */
    .entity-card {
      transition: transform 150ms ease-out, box-shadow 150ms ease-out;
    }

    .entity-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: var(--accent);
      opacity: 0;
      transition: opacity 150ms ease-out;
      border-radius: 1px 0 0 1px;
    }

    .entity-card:hover::before {
      opacity: 1;
    }

    .entity-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.1);
    }

    .entity-card:hover .card-title {
      color: #0F172A;
    }

    /* Buttons */
    .btn-outline {
      transition: background-color 150ms ease-out, border-color 150ms ease-out;
    }

    .btn-outline:hover {
      background-color: rgba(74, 111, 165, 0.06);
      border-color: var(--accent);
    }

    .btn-outline:hover .btn-arrow {
      transform: translateX(3px);
    }

    .btn-arrow {
      transition: transform 150ms ease-out;
    }

    /* Filter pill */
    .filter-pill {
      transition: background-color 120ms ease-out, border-color 120ms ease-out, color 120ms ease-out;
    }

    .filter-pill.active {
      background-color: var(--accent);
      border-color: var(--accent);
      color: white;
      border-width: 1.5px;
    }

    .filter-pill:not(.active):hover {
      background-color: rgba(74, 111, 165, 0.05);
      border-color: var(--accent);
    }

    /* View CTA */
    .view-cta {
      transition: color 150ms ease-out;
    }

    .view-cta:hover {
      color: var(--accent-dark);
    }

    .view-cta:hover .view-arrow {
      transform: translateX(3px);
    }

    .view-arrow {
      transition: transform 150ms ease-out;
    }

    /* Pagination */
    .page-dot {
      transition: background-color 120ms ease-out;
    }

    .pagination-btn {
      transition: color 120ms ease-out;
    }

    .pagination-btn:hover:not(:disabled) {
      color: var(--fg);
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Focus visible */
    button:focus-visible,
    a:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Search wrapper underline */
    .search-wrapper {
      position: relative;
    }

    .search-wrapper::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background-color: rgba(74, 111, 165, 0.25);
      transition: background-color 150ms ease-out;
      border-radius: 0 0 8px 8px;
    }

    .search-wrapper:focus-within::after {
      background-color: var(--accent);
    }

    /* Loading skeleton */
    .loading-skeleton {
      background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--muted);
    }

    /* Footer links */
    .footer-link {
      text-decoration: none;
      color: #B8C5D4;
    }

    .footer-link:hover {
      text-decoration: underline;
      text-underline-offset: 4px;
      color: #E8EDF3;
    }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  
  <div class="main-content">

    <!-- [2] Institutional Hero Layer -->
    <header class="pt-12 pb-16 px-6">
      <div class="max-w-6xl mx-auto text-center">
        
        <div class="animate-entrance delay-1 mb-8">
          <div class="inline-flex items-center justify-center w-20 h-20">
            <img 
              src="logo.png" 
              alt="INDEX GENTIUM Crest" 
              class="w-16 h-16 object-contain opacity-90"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            >
            <div class="hidden w-16 h-16 rounded-full border-2 border-border bg-card items-center justify-center">
              <svg class="w-8 h-8 text-fg opacity-60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
            </div>
          </div>
        </div>

        <p class="animate-entrance delay-2 font-mono text-xs tracking-[0.2em] text-muted uppercase mb-6">EST. MMXXIV</p>

        <h1 class="animate-entrance delay-2 font-display text-5xl md:text-6xl lg:text-7xl font-medium tracking-tight text-fg mb-4">
          INDEX GENTIUM
        </h1>

        <p class="animate-entrance delay-3 font-display text-xl md:text-2xl italic text-muted mb-6">
          Laboratorium Arbitristae
        </p>

        <p class="animate-entrance delay-3 max-w-xl mx-auto text-muted leading-relaxed">
          A curated registry of sovereign entities, institutions, and classifications for structured inquiry and institutional reference.
        </p>
      </div>
    </header>

    <!-- [3] Inquiry Layer -->
    <section class="pb-8 px-6">
      <div class="max-w-3xl mx-auto animate-entrance delay-4">
        
        <label for="searchInput" class="block font-mono text-xs tracking-[0.15em] text-muted uppercase mb-4 text-center">
          Inquire the Registry
        </label>

        <!-- Search Module -->
        <div class="search-module" id="searchModule">
          <div class="search-wrapper rounded-lg">
            <div class="flex flex-col sm:flex-row gap-3">
              <div class="relative flex-1">
                <input 
                  type="text" 
                  id="searchInput"
                  class="search-input w-full h-14 px-5 pr-12 text-base bg-card border border-border rounded-lg shadow-sm"
                  placeholder="Search sovereign entities, regions, or classifications…"
                  autocomplete="off"
                  aria-label="Search entities"
                  aria-describedby="searchHelp"
                  aria-expanded="false"
                  aria-controls="searchDropdown"
                  aria-autocomplete="list"
                  role="combobox"
                >
                <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted pointer-events-none" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true">
                  <circle cx="11" cy="11" r="8"/>
                  <path d="m21 21-4.35-4.35"/>
                </svg>
              </div>

              <button class="btn-outline h-14 px-8 border border-border rounded-lg font-medium text-fg flex items-center justify-center gap-2 whitespace-nowrap" aria-label="Explore all entities">
                <span>Explore</span>
                <svg class="btn-arrow w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
              </button>
            </div>
          </div>
          <p id="searchHelp" class="sr-only">Type to search through sovereign entities, regions, or classifications</p>

          <!-- Dropdown Panel - Static flow, pushes content down -->
          <div 
            id="searchDropdown" 
            class="search-dropdown" 
            role="listbox"
            aria-label="Search suggestions"
          >
            <div class="dropdown-metadata">
              <div class="dropdown-metadata-title">Registry Summary</div>
              <div class="dropdown-metadata-stats" id="metadataStats">
                <!-- Populated by JS -->
              </div>
            </div>
            
            <div class="dropdown-results-header" id="resultsHeader">
              Matching Entities
            </div>
            <div class="dropdown-results" id="dropdownResults" role="listbox">
              <!-- Items rendered by JS -->
            </div>
            
            <div class="scroll-indicator hidden" id="scrollIndicator">
              Scroll or use arrow keys to see more results
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- [4] Classification Filter Layer -->
    <section class="py-10 px-6">
      <div class="max-w-6xl mx-auto animate-entrance delay-5">
        <div class="flex flex-wrap justify-center gap-3" role="tablist" aria-label="Filter by classification">
          <button class="filter-pill active px-5 py-2 border border-border rounded-full text-sm font-medium" data-filter="all" role="tab" aria-selected="true">
            All Nations
          </button>
        </div>
      </div>
    </section>

    <!-- [5] Entity Registry Grid -->
    <section class="pb-16 px-6">
      <div class="max-w-6xl mx-auto">
        
        <div id="loadingSkeleton" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="bg-card border border-border rounded-xl p-6">
            <div class="loading-skeleton h-6 w-24 rounded mb-4"></div>
            <div class="loading-skeleton h-5 w-32 rounded mb-3"></div>
            <div class="loading-skeleton h-4 w-full rounded mb-2"></div>
            <div class="loading-skeleton h-4 w-3/4 rounded mb-4"></div>
            <div class="loading-skeleton h-4 w-20 rounded"></div>
          </div>
          <div class="bg-card border border-border rounded-xl p-6 hidden md:block">
            <div class="loading-skeleton h-6 w-24 rounded mb-4"></div>
            <div class="loading-skeleton h-5 w-32 rounded mb-3"></div>
            <div class="loading-skeleton h-4 w-full rounded mb-2"></div>
            <div class="loading-skeleton h-4 w-3/4 rounded mb-4"></div>
            <div class="loading-skeleton h-4 w-20 rounded"></div>
          </div>
          <div class="bg-card border border-border rounded-xl p-6 hidden lg:block">
            <div class="loading-skeleton h-6 w-24 rounded mb-4"></div>
            <div class="loading-skeleton h-5 w-32 rounded mb-3"></div>
            <div class="loading-skeleton h-4 w-full rounded mb-2"></div>
            <div class="loading-skeleton h-4 w-3/4 rounded mb-4"></div>
            <div class="loading-skeleton h-4 w-20 rounded"></div>
          </div>
        </div>

        <div id="entityGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" role="list" aria-label="Entity registry">
        </div>

        <div id="emptyState" class="hidden py-20 text-center">
          <p class="text-muted">No matching entities found.</p>
        </div>

      </div>
    </section>

    <!-- [9] Pagination Layer -->
    <section id="paginationSection" class="hidden pb-20 px-6">
      <div class="max-w-6xl mx-auto flex items-center justify-center gap-6">
        <button id="prevBtn" class="pagination-btn flex items-center gap-2 text-sm text-muted disabled:opacity-40 disabled:cursor-not-allowed" disabled aria-label="Previous page">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          <span>Prev</span>
        </button>

        <div id="pageIndicator" class="flex items-center gap-2" role="tablist" aria-label="Page navigation">
        </div>

        <button id="nextBtn" class="pagination-btn flex items-center gap-2 text-sm text-muted" aria-label="Next page">
          <span>Next</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
      </div>
    </section>

  </div>

  <footer class="site-footer py-14 md:py-20 lg:py-24 px-6" style="background-color: #0B1A2B;">
    <div class="max-w-6xl mx-auto">
      <p class="font-display text-xl md:text-2xl tracking-widest text-center mb-10 md:mb-12" style="color: #E8EDF3;">ARBITRISTAE</p>
      <nav class="flex flex-col md:flex-row justify-center items-center gap-6 md:gap-10 mb-10 md:mb-12" aria-label="Footer navigation">
        <a href="#" class="footer-link text-sm">About</a>
        <a href="#" class="footer-link text-sm">Methodology</a>
        <a href="#" class="footer-link text-sm">Contact</a>
      </nav>
      <p class="font-mono text-xs tracking-wide text-center" style="color: #5A7089;">MMXXIV</p>
    </div>
  </footer>

  <script>
    // State initialization
    let entities = [];
    let currentFilter = 'all';
    let currentPage = 1;
    const itemsPerPage = 6;
    let filteredEntities = [];
    
    // Dropdown state
    let dropdownOpen = false;
    let activeIndex = -1;
    let currentMatches = [];
    const VISIBLE_ITEMS = 5;

    // DOM Elements
    const searchModule = document.getElementById('searchModule');
    const searchInput = document.getElementById('searchInput');
    const searchDropdown = document.getElementById('searchDropdown');
    const metadataStats = document.getElementById('metadataStats');
    const dropdownResults = document.getElementById('dropdownResults');
    const resultsHeader = document.getElementById('resultsHeader');
    const scrollIndicator = document.getElementById('scrollIndicator');
    const entityGrid = document.getElementById('entityGrid');
    const loadingSkeleton = document.getElementById('loadingSkeleton');
    const emptyState = document.getElementById('emptyState');
    const pageIndicator = document.getElementById('pageIndicator');
    const paginationSection = document.getElementById('paginationSection');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const filterPills = document.querySelectorAll('.filter-pill');

    function getClassificationCounts() {
      const counts = {};
      entities.forEach(entity => {
        const tag = entity.tags;
        counts[tag] = (counts[tag] || 0) + 1;
      });
      return counts;
    }

    function renderMetadata(matchCount) {
      const classCounts = getClassificationCounts();
      const totalEntities = entities.length;
      
      let statsHTML = `
        <div class="metadata-stat">
          <span class="metadata-stat-value">${totalEntities}</span>
          <span class="metadata-stat-label">Total</span>
        </div>
      `;
      
      const entries = Object.entries(classCounts).slice(0, 3);
      entries.forEach(([tag, count]) => {
        statsHTML += `
          <div class="metadata-stat">
            <span class="metadata-stat-value">${count}</span>
            <span class="metadata-stat-label">${tag}</span>
          </div>
        `;
      });
      
      metadataStats.innerHTML = statsHTML;
      
      if (matchCount > 0) {
        resultsHeader.textContent = `${matchCount} Matching ${matchCount === 1 ? 'Entity' : 'Entities'}`;
      } else {
        resultsHeader.textContent = 'No Matches';
      }
    }

    async function loadCatalog() {
      try {
        const response = await fetch('catalog.json');
        if (!response.ok) throw new Error('Catalog not found');
        
        const data = await response.json();
        entities = data.countries || [];
        filteredEntities = [...entities];


        loadingSkeleton.classList.add('hidden');
        entityGrid.classList.remove('hidden');
        
        renderGrid();
      } catch (error) {
        console.error('Failed to load catalog:', error);
        loadingSkeleton.classList.add('hidden');
        emptyState.classList.remove('hidden');
        emptyState.innerHTML = '<p class="text-muted">Unable to load registry data.</p><p class="text-sm text-muted/60 mt-2">Please ensure catalog.json is available.</p>';
      }
    }

    function openDropdown() {
      dropdownOpen = true;
      searchDropdown.classList.add('open');
      searchInput.setAttribute('aria-expanded', 'true');
    }

    function closeDropdown() {
      dropdownOpen = false;
      activeIndex = -1;
      searchDropdown.classList.remove('open');
      searchInput.setAttribute('aria-expanded', 'false');
      clearActiveItem();
    }

    function clearActiveItem() {
      const items = dropdownResults.querySelectorAll('.search-dropdown-item');
      items.forEach(item => item.classList.remove('active'));
    }

    function setActiveItem(index) {
      const items = dropdownResults.querySelectorAll('.search-dropdown-item');
      clearActiveItem();
      if (index >= 0 && index < items.length) {
        items[index].classList.add('active');
        items[index].scrollIntoView({ block: 'nearest' });
      }
    }

    function selectItem(index) {
      if (index >= 0 && index < currentMatches.length) {
        const entity = currentMatches[index];
        searchInput.value = entity.name;
        closeDropdown();
        filterEntities();
      }
    }

    function renderDropdown(term) {
      if (term.length < 2) {
        currentMatches = [];
        renderMetadata(0);
        dropdownResults.innerHTML = `
          <div class="px-4 py-6 text-center text-sm text-muted">
            Type at least 2 characters to search
          </div>
        `;
        scrollIndicator.classList.add('hidden');
        openDropdown();
        return;
      }

      currentMatches = entities.filter(e => 
        e.name.toLowerCase().includes(term.toLowerCase()) ||
        e.tags.toLowerCase().includes(term.toLowerCase())
      );

      renderMetadata(currentMatches.length);

      if (currentMatches.length === 0) {
        dropdownResults.innerHTML = `
          <div class="px-4 py-6 text-center text-sm text-muted">
            No entities found
          </div>
        `;
        scrollIndicator.classList.add('hidden');
        openDropdown();
        return;
      }

      // Render all matches; container max-height shows 5 at a time
      dropdownResults.innerHTML = currentMatches.map((entity, idx) => `
        <div 
          class="search-dropdown-item" 
          data-index="${idx}"
          role="option"
          tabindex="-1"
          aria-selected="false"
        >
          <div class="flex items-center gap-3">
            <span class="text-lg" aria-hidden="true">${entity.icon}</span>
            <div class="flex-1 min-w-0">
              <p class="font-medium text-fg truncate">${entity.name}</p>
              <p class="text-xs text-muted">${entity.tags}</p>
            </div>
          </div>
        </div>
      `).join('');

      // Show scroll indicator if more than 5 items
      if (currentMatches.length > VISIBLE_ITEMS) {
        scrollIndicator.classList.remove('hidden');
        scrollIndicator.textContent = `${currentMatches.length - VISIBLE_ITEMS} more — scroll or use arrow keys`;
      } else {
        scrollIndicator.classList.add('hidden');
      }

      // Attach event listeners
      const items = dropdownResults.querySelectorAll('.search-dropdown-item');
      items.forEach((item, idx) => {
        item.addEventListener('mouseenter', () => {
          activeIndex = idx;
          setActiveItem(idx);
        });
        item.addEventListener('click', () => {
          selectItem(idx);
        });
      });

      activeIndex = -1;
      openDropdown();
    }

    function renderCard(entity) {
      const code = entity.code || entity.name.substring(0, 2).toUpperCase() + '-001';
      
      return `
        <article class="entity-card relative bg-card border border-border rounded-xl p-6 shadow-sm" role="listitem">
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
              <span class="text-2xl" aria-hidden="true">${entity.icon}</span>
              <div>
                <span class="inline-block px-2 py-0.5 text-xs font-mono tracking-wide text-muted bg-muted/10 rounded">${entity.tags}</span>
              </div>
            </div>
            <span class="flex items-center gap-1.5 text-xs text-muted">
              <span class="w-1.5 h-1.5 rounded-full bg-green-500" aria-hidden="true"></span>
              <span class="sr-only">Status:</span>Active
            </span>
          </div>
          
          <h3 class="card-title font-display text-xl font-medium text-fg mb-2 transition-colors duration-150">${entity.name}</h3>
          <p class="text-sm text-muted leading-relaxed mb-4">${entity.description}</p>
          
          <div class="flex items-center justify-between pt-4 border-t border-border">
            <span class="font-mono text-xs text-muted/60">${code}</span>
            <a href="${entity.link}" class="view-cta inline-flex items-center gap-1.5 text-sm font-medium text-accent" aria-label="View details for ${entity.name}">
              <span>View</span>
              <svg class="view-arrow w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </a>
          </div>
        </article>
      `;
    }

    function renderGrid() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageEntities = filteredEntities.slice(startIndex, endIndex);

      if (filteredEntities.length === 0) {
        entityGrid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        emptyState.innerHTML = '<p class="text-muted">No matching entities found.</p>';
        paginationSection.classList.add('hidden');
      } else {
        emptyState.classList.add('hidden');
        entityGrid.classList.remove('hidden');
        entityGrid.innerHTML = pageEntities.map(renderCard).join('');
        
        if (filteredEntities.length > itemsPerPage) {
          paginationSection.classList.remove('hidden');
          renderPagination();
        } else {
          paginationSection.classList.add('hidden');
        }
      }
    }

    function renderPagination() {
      const totalPages = Math.max(1, Math.ceil(filteredEntities.length / itemsPerPage));
      
      let dotsHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const isActive = i === currentPage;
        dotsHTML += `
          <button 
            class="page-dot ${isActive ? 'w-6 h-2 bg-accent' : 'w-2 h-2 bg-border hover:bg-muted'} rounded-full transition-all duration-120" 
            data-page="${i}" 
            aria-label="Page ${i}" 
            aria-selected="${isActive}"
            role="tab"
          ></button>
        `;
      }
      pageIndicator.innerHTML = dotsHTML;

      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      document.querySelectorAll('.page-dot').forEach(dot => {
        dot.addEventListener('click', () => {
          currentPage = parseInt(dot.dataset.page);
          renderGrid();
          entityGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      });
    }

    function filterEntities() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      
      filteredEntities = entities.filter(entity => {
        const matchesFilter = currentFilter === 'all' || entity.tags === currentFilter;
        const matchesSearch = searchTerm === '' || 
          entity.name.toLowerCase().includes(searchTerm) ||
          entity.description.toLowerCase().includes(searchTerm) ||
          entity.tags.toLowerCase().includes(searchTerm);
        
        return matchesFilter && matchesSearch;
      });

      currentPage = 1;
      renderGrid();
    }

    // Search Input Events
    searchInput.addEventListener('input', (e) => {
      renderDropdown(e.target.value);
      filterEntities();
    });

    searchInput.addEventListener('focus', () => {
      renderDropdown(searchInput.value);
    });

    // Keyboard Navigation
    searchInput.addEventListener('keydown', (e) => {
      const items = dropdownResults.querySelectorAll('.search-dropdown-item');
      
      if (!dropdownOpen) {
        if (e.key === 'ArrowDown' && searchInput.value.length >= 2) {
          e.preventDefault();
          renderDropdown(searchInput.value);
        }
        return;
      }

      switch (e.key) {
        case 'ArrowDown':
          e.preventDefault();
          activeIndex = Math.min(activeIndex + 1, items.length - 1);
          setActiveItem(activeIndex);
          break;
        case 'ArrowUp':
          e.preventDefault();
          activeIndex = Math.max(activeIndex - 1, 0);
          setActiveItem(activeIndex);
          break;
        case 'Enter':
          e.preventDefault();
          if (activeIndex >= 0 && activeIndex < items.length) {
            selectItem(activeIndex);
          }
          break;
        case 'Escape':
          e.preventDefault();
          closeDropdown();
          searchInput.focus();
          break;
        case 'Tab':
          closeDropdown();
          break;
      }
    });

    // Click outside to close
    document.addEventListener('click', (e) => {
      const isInsideSearchModule = searchModule.contains(e.target);
      const isFilterPill = e.target.closest('.filter-pill');
      
      if (!isInsideSearchModule && !isFilterPill) {
        closeDropdown();
      }
    });

    // Filter pills interaction
    filterPills.forEach(pill => {
      pill.addEventListener('click', () => {
        filterPills.forEach(p => {
          p.classList.remove('active');
          p.setAttribute('aria-selected', 'false');
        });
        pill.classList.add('active');
        pill.setAttribute('aria-selected', 'true');
        currentFilter = pill.dataset.filter;
        filterEntities();
        // Dropdown stays open per spec
      });
    });

    // Pagination buttons
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderGrid();
        entityGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });

    nextBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(filteredEntities.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderGrid();
        entityGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });

    // Initialize
    loadCatalog();
  </script>
</body>
</html>